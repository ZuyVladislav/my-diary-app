<!doctype html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–î–Ω–µ–≤–Ω–∏–∫ –∑–∞–Ω—è—Ç–∏–π</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .hidden { display: none !important; }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,.72); }
    .shadow-soft { box-shadow: 0 10px 30px rgba(0,0,0,.10); }
    .focus-ring:focus { outline: none; box-shadow: 0 0 0 4px rgba(99,102,241,.25); border-color: rgba(99,102,241,.85); }
    .mono { font-variant-numeric: tabular-nums; }
    .linkish { text-decoration: underline; text-underline-offset: 3px; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-indigo-50 via-slate-50 to-fuchsia-50 text-slate-900">

  <!-- Overlay: –∑–∞–≥—Ä—É–∑–∫–∞/—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è -->
  <div id="syncOverlay" class="hidden fixed inset-0 bg-white/70 backdrop-blur-sm z-50">
    <div class="h-full flex items-center justify-center p-6">
      <div class="glass rounded-2xl border border-white/60 shadow-soft p-6 max-w-md w-full">
        <div class="text-lg font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö‚Ä¶</div>
        <div id="syncOverlayText" class="mt-2 text-sm text-slate-600">
          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.
        </div>
      </div>
    </div>
  </div>

  <!-- Auth gate (–°–ù–ê–†–£–ñ–ò appRoot) -->
  <div id="authGate" class="max-w-6xl mx-auto px-4 py-8 hidden">
    <div class="glass rounded-2xl border border-white/60 shadow-soft p-6">
      <h2 class="text-2xl font-semibold">–í—Ö–æ–¥</h2>
      <p class="mt-2 text-slate-600">
        –ß—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –¥–Ω–µ–≤–Ω–∏–∫, –≤–æ–π–¥–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å (–¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–µ, –ø–∞–ø–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è).
      </p>

      <div class="mt-4 flex flex-wrap gap-2">
        <button id="btnLoginYandex"
          class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-soft">
          –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –Ø–Ω–¥–µ–∫—Å
        </button>

        <button id="btnDevSkip"
          class="px-4 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-white shadow-soft">
          –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å (–ª–æ–∫–∞–ª—å–Ω–æ)
        </button>
      </div>

      <div class="mt-3 text-xs text-slate-500">
        Debug: <span id="authDebug" class="mono"></span>
      </div>
    </div>
  </div>

  <!-- App (–ò–ó–ù–ê–ß–ê–õ–¨–ù–û –°–ö–†–´–¢) -->
  <div id="appRoot" class="max-w-6xl mx-auto px-4 py-8 hidden">

    <!-- Header -->
    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold tracking-tight">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–Ω–µ–≤–Ω–∏–∫ –∑–∞–Ω—è—Ç–∏–π</h1>
      </div>

      <div class="flex flex-wrap gap-2">
        <button id="btnManageStudents"
          class="px-4 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-white shadow-soft">
          üë§ –£—á–µ–Ω–∏–∫–∏
        </button>
        <button id="btnManageBooks"
          class="px-4 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-white shadow-soft">
          üìò –£—á–µ–±–Ω–∏–∫–∏ (PDF)
        </button>
        <button id="btnExport"
          class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-soft">
          ‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç
        </button>
        <label class="px-4 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-white shadow-soft cursor-pointer">
          ‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç
          <input id="fileImport" type="file" accept="application/json" class="hidden">
        </label>

        <div id="whoami" class="px-3 py-2 text-sm text-slate-700 hidden whitespace-nowrap"></div>

        <button id="btnLoginTop"
          class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-soft hidden">
          üîë –í–æ–π—Ç–∏
        </button>

        <button id="btnLogout"
          class="px-4 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-white shadow-soft hidden">
          üö™ –í—ã–π—Ç–∏
        </button>

        <button id="btnSwitch"
          class="px-4 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-white shadow-soft hidden">
          üîÑ –°–º–µ–Ω–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç
        </button>
      </div>
    </div>

    <!-- Add lesson -->
    <div class="mt-6 glass rounded-2xl border border-white/60 shadow-soft p-5">
      <div class="flex items-center justify-between gap-3">
        <h2 class="text-xl font-semibold">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–Ω—è—Ç–∏–µ</h2>
        <div class="text-xs text-slate-500">–ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ: <span class="font-medium text-slate-700">–≤–∫–ª—é—á–µ–Ω–æ</span></div>
      </div>

      <form id="lessonForm" class="mt-4 grid grid-cols-1 md:grid-cols-12 gap-3">
        <div class="md:col-span-3">
          <label class="text-sm text-slate-700">–£—á–µ–Ω–∏–∫</label>
          <select id="studentSelect" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring"></select>
        </div>

        <div class="md:col-span-3">
          <label class="text-sm text-slate-700">–£—á–µ–±–Ω–∏–∫</label>
          <select id="bookSelect" class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring"></select>
        </div>

        <div class="md:col-span-2">
          <label class="text-sm text-slate-700">–î–∞—Ç–∞</label>
          <input id="dateInput" type="date"
                 class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring mono"/>
        </div>

        <div class="md:col-span-4">
          <label class="text-sm text-slate-700">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</label>
          <input id="hwInput" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Å—Ç—Ä. 25 —É–ø—Ä. 3‚Äì5"
                 class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring"/>
        </div>

        <div class="md:col-span-10">
          <label class="text-sm text-slate-700">–ù–∞ —á–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å</label>
          <input id="stopInput" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: Past Simple, –ø—Ä–∞–≤–∏–ª–∞ + –ø—Ä–∞–∫—Ç–∏–∫–∞"
                 class="w-full mt-1 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring"/>
        </div>

        <div class="md:col-span-2 flex items-end">
          <button type="submit"
            class="w-full px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 shadow-soft">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      </form>
    </div>

    <!-- History -->
    <div class="mt-6 glass rounded-2xl border border-white/60 shadow-soft p-5">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <h2 class="text-xl font-semibold">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–Ω—è—Ç–∏–π</h2>

        <div class="flex flex-col md:flex-row gap-2 md:items-center">
          <select id="filterStudent" class="px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring">
            <option value="">–í—Å–µ —É—á–µ–Ω–∏–∫–∏</option>
          </select>

          <div class="flex items-center gap-2">
            <input id="filterDate" type="date"
                   class="px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring mono"
                   title="–§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ" />
            <button id="btnClearDate" type="button"
              class="px-3 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-white shadow-soft"
              title="–°–±—Ä–æ—Å–∏—Ç—å –¥–∞—Ç—É">
              ‚úñ
            </button>
          </div>

          <input id="filterQuery" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ –î–ó/–æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å‚Ä¶"
                 class="px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring"/>

          <button id="btnClearAll" type="button"
            class="px-4 py-2 rounded-xl bg-white/80 border border-rose-200 text-rose-700 hover:bg-white shadow-soft">
            üßπ –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
          </button>
        </div>
      </div>

      <div class="mt-4 overflow-x-auto">
        <table class="w-full text-sm">
          <thead>
            <tr class="text-left text-slate-600">
              <th class="py-2 pr-3">–î–∞—Ç–∞</th>
              <th class="py-2 pr-3">–£—á–µ–Ω–∏–∫</th>
              <th class="py-2 pr-3">–£—á–µ–±–Ω–∏–∫</th>
              <th class="py-2 pr-3">–î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ</th>
              <th class="py-2 pr-3">–ù–∞ —á–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å</th>
              <th class="py-2 pr-0 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
          </thead>
          <tbody id="lessonsTbody" class="align-top"></tbody>
        </table>
      </div>

      <div id="emptyState" class="hidden mt-6 text-center text-slate-600">
        <div class="text-5xl">üóÇÔ∏è</div>
        <div class="mt-2 font-medium">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>
        <div class="text-sm">–î–æ–±–∞–≤—å –ø–µ—Ä–≤–æ–µ –∑–∞–Ω—è—Ç–∏–µ ‚Äî –∏ –æ–Ω–æ –ø–æ—è–≤–∏—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏.</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="hidden fixed inset-0 bg-black/30 p-4">
    <div class="max-w-5xl w-full mx-auto mt-10 glass rounded-2xl border border-white/60 shadow-soft overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b border-white/60">
        <div>
          <div id="modalTitle" class="text-lg font-semibold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</div>
          <div id="modalSubtitle" class="text-sm text-slate-600">–î–æ–±–∞–≤–ª—è–π/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π/—É–¥–∞–ª—è–π</div>
        </div>
        <button id="modalClose" type="button" class="px-3 py-1 rounded-xl hover:bg-white relative z-10">‚úñ</button>
      </div>

      <!-- Add area -->
      <div class="rounded-2xl border border-white/60 bg-white/55 p-4">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 items-end">
          <div class="lg:col-span-5">
            <label class="block text-xs font-medium text-slate-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
            <input id="modalNewName" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤ / Begegnungen B1.2"
              class="w-full px-3 py-2.5 rounded-xl border border-slate-200 bg-white focus-ring"/>
          </div>

          <div id="modalPdfArea" class="lg:col-span-5 hidden">
            <label class="block text-xs font-medium text-slate-700 mb-1">PDF (—Ä—è–¥–æ–º —Å diary.html)</label>
            <div class="flex gap-2">
              <input id="modalNewPdfLabel" disabled
                class="flex-1 min-w-0 px-3 py-2.5 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 truncate"
                value="PDF –Ω–µ –≤—ã–±—Ä–∞–Ω"/>

              <label class="shrink-0 px-3 py-2.5 rounded-xl bg-white border border-slate-200 hover:bg-slate-50 shadow-soft cursor-pointer whitespace-nowrap">
                üìé –í—ã–±—Ä–∞—Ç—å
                <input id="modalNewPdfPick" type="file" accept="application/pdf" class="hidden">
              </label>
            </div>
          </div>

          <div class="lg:col-span-2">
            <button id="modalAddBtn" type="button"
              class="w-full px-4 py-2.5 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-soft whitespace-nowrap">
              ‚ûï –î–æ–±–∞–≤–∏—Ç—å
            </button>
          </div>
        </div>
      </div>

      <div class="mt-8">
        <div class="text-sm text-slate-700 ml-3 -mt-5">–°–ø–∏—Å–æ–∫</div>
        <div id="modalList" class="space-y-3 max-h-[45vh] overflow-y-auto pr-1"></div>
      </div>

      <div class="px-5 py-4 border-t border-white/60 flex justify-end">
        <button id="modalDone" type="button" class="px-4 py-2 rounded-xl bg-white/80 border border-slate-200 hover:bg-white shadow-soft">
          –ì–æ—Ç–æ–≤–æ
        </button>
      </div>
    </div>
  </div>

<script>
/** =========================================================
 *  –ù–ê–°–¢–†–û–ô–ö–ò
 *  ========================================================= */
const CLIENT_ID = "78e32340ec07426eb89d20d4301fc224";
const REDIRECT_URI = "https://zuyvladislav.github.io/my-diary-app/"; // –î–û–õ–ñ–ù–û —Å–æ–≤–ø–∞—Å—Ç—å —Å OAuth –Ω–∞—Å—Ç—Ä–æ–π–∫–æ–π
const DISK_STATE_PATH = "app:/diary-state.json"; // app folder
const STORAGE_KEY_LOCAL = "lesson_diary_v2_local";

/** =========================================================
 *  –£–¢–ò–õ–ò–¢–´
 *  ========================================================= */
function todayISO() {
  const d = new Date();
  const tzOff = d.getTimezoneOffset() * 60000;
  return new Date(d - tzOff).toISOString().slice(0, 10);
}
function uid() {
  return Math.random().toString(16).slice(2) + Date.now().toString(16);
}
function escapeHtml(str=""){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;");
}
function defaultState() {
  return {
    students: [{ id: uid(), name: "–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤" }],
    books: [{ id: uid(), name: "–£—á–µ–±–Ω–∏–∫ 1", pdfName: "" }],
    lessons: []
  };
}

/** =========================================================
 *  –†–ï–ñ–ò–ú–´ / –¢–û–ö–ï–ù
 *  ========================================================= */
function getToken() {
  return localStorage.getItem("yandex_oauth_token") || "";
}
function isYandexLoggedIn() {
  return !!getToken();
}
function isLocalMode() {
  return localStorage.getItem("auth_mode") === "local";
}
function canEnterApp() {
  return isYandexLoggedIn() || isLocalMode();
}
function setSyncOverlay(on, text="") {
  const ov = document.getElementById("syncOverlay");
  const tx = document.getElementById("syncOverlayText");
  if (tx) tx.textContent = text || "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏ –ø–∞—Ä—É —Å–µ–∫—É–Ω–¥.";
  ov?.classList.toggle("hidden", !on);
}

/** =========================================================
 *  LOCAL STORAGE (—Ç–æ–ª—å–∫–æ –¥–ª—è local-—Ä–µ–∂–∏–º–∞)
 *  ========================================================= */
function loadStateLocal() {
  const raw = localStorage.getItem(STORAGE_KEY_LOCAL);
  if (!raw) return defaultState();
  try { return JSON.parse(raw); } catch { return defaultState(); }
}
function saveStateLocal(s) {
  localStorage.setItem(STORAGE_KEY_LOCAL, JSON.stringify(s));
}

/** =========================================================
 *  YANDEX OAUTH (implicit)
 *  ========================================================= */
function randomState() {
  return crypto.getRandomValues(new Uint32Array(4)).join("-");
}

function startYandexLogin() {
  const st = randomState();
  localStorage.setItem("yandex_oauth_state", st);
  sessionStorage.setItem("yandex_oauth_state", st);

  const url = new URL("https://oauth.yandex.ru/authorize");
  url.searchParams.set("response_type", "token");
  url.searchParams.set("client_id", CLIENT_ID);
  url.searchParams.set("redirect_uri", REDIRECT_URI);
  url.searchParams.set("scope", "cloud_api:disk.app_folder");
  url.searchParams.set("state", st);
  url.searchParams.set("prompt", "login"); // —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –∞–∫–∫–∞—É–Ω—Ç

  location.href = url.toString();
}

async function fetchYandexUser(token) {
  const r = await fetch("https://login.yandex.ru/info?format=json", {
    headers: { Authorization: `OAuth ${token}` }
  });
  if (!r.ok) throw new Error("profile fetch failed");
  return r.json();
}

async function handleOAuthReturn() {
  const hash = new URLSearchParams(location.hash.slice(1));
  const token = hash.get("access_token");
  const state = hash.get("state");

  if (!token) return;

  // —á–∏—Å—Ç–∏–º URL —Å—Ä–∞–∑—É
  history.replaceState({}, "", location.pathname);

  const savedState =
    localStorage.getItem("yandex_oauth_state") ||
    sessionStorage.getItem("yandex_oauth_state");

  // –µ—Å–ª–∏ savedState –µ—Å—Ç—å –∏ –Ω–µ —Å–æ–≤–ø–∞–ª ‚Äî –Ω–µ –ª–æ–≥–∏–Ω–∏–º
  // –µ—Å–ª–∏ savedState –ø—Ä–æ–ø–∞–ª (—á–∞—Å—Ç–æ –Ω–∞ –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö) ‚Äî –ª–æ–≥–∏–Ω–∏–º –≤—Å—ë —Ä–∞–≤–Ω–æ
  if (savedState && state && state !== savedState) return;

  localStorage.setItem("yandex_oauth_token", token);
  localStorage.removeItem("yandex_oauth_state");
  sessionStorage.removeItem("yandex_oauth_state");
  localStorage.removeItem("auth_mode");

  try {
    const me = await fetchYandexUser(token);
    localStorage.setItem(
      "yandex_user_display",
      me.display_name || me.real_name || me.login || "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
    );
  } catch {
    localStorage.setItem("yandex_user_display", "");
  }
}

/** =========================================================
 *  YANDEX DISK API (app folder) ‚Äî –ü–†–û–°–¢–û
 *  ========================================================= */
async function diskApi(url, { method="GET", token, headers={}, body } = {}) {
  const r = await fetch(url, {
    method,
    headers: {
      Authorization: `OAuth ${token}`,
      ...headers
    },
    body
  });
  return r;
}

async function loadStateFromDisk() {
  const token = getToken();
  if (!token) throw new Error("no token");

  // 1) href –Ω–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ
  const dl = await diskApi(
    `https://cloud-api.yandex.net/v1/disk/resources/download?path=${encodeURIComponent(DISK_STATE_PATH)}`,
    { token }
  );

  if (dl.status === 404) {
    // —Ñ–∞–π–ª–∞ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—ë–º –¥–µ—Ñ–æ–ª—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º
    const s = defaultState();
    await saveStateToDisk(s);
    return s;
  }
  if (!dl.ok) throw new Error("download link failed");

  const { href } = await dl.json();

  // 2) —Å–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
  const file = await fetch(href);
  if (!file.ok) throw new Error("file fetch failed");

  const json = await file.json();

  // –≤–∞–ª–∏–¥–∞—Ü–∏—è
  if (!json || typeof json !== "object") return defaultState();
  if (!Array.isArray(json.students) || !Array.isArray(json.books) || !Array.isArray(json.lessons)) {
    return defaultState();
  }
  return json;
}

async function saveStateToDisk(stateObj) {
  const token = getToken();
  if (!token) throw new Error("no token");

  // 1) href –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É
  const up = await diskApi(
    `https://cloud-api.yandex.net/v1/disk/resources/upload?path=${encodeURIComponent(DISK_STATE_PATH)}&overwrite=true`,
    { token }
  );
  if (!up.ok) throw new Error("upload link failed");

  const { href } = await up.json();

  // 2) PUT json
  const data = JSON.stringify(stateObj, null, 2);
  const put = await fetch(href, {
    method: "PUT",
    headers: { "Content-Type": "application/json" },
    body: data
  });
  if (!put.ok) throw new Error("put failed");
}

/** =========================================================
 *  UI: gate/app
 *  ========================================================= */
function showAppOrLogin() {
  const gate = document.getElementById("authGate");
  const app  = document.getElementById("appRoot");
  const dbg  = document.getElementById("authDebug");

  const btnLoginYandex = document.getElementById("btnLoginYandex");
  const btnDevSkip     = document.getElementById("btnDevSkip");

  const btnLoginTop = document.getElementById("btnLoginTop");
  const btnLogout   = document.getElementById("btnLogout");
  const btnSwitch   = document.getElementById("btnSwitch");
  const who         = document.getElementById("whoami");

  const logged = isYandexLoggedIn();
  const local  = isLocalMode();
  const enter  = canEnterApp();

  gate?.classList.toggle("hidden", enter);
  app?.classList.toggle("hidden", !enter);

  // —à–∞–ø–∫–∞
  btnLoginTop?.classList.toggle("hidden", logged);
  btnLogout?.classList.toggle("hidden", !logged);
  btnSwitch?.classList.toggle("hidden", !logged);

  // whoami
  if (who) {
    who.classList.toggle("hidden", !logged);
    const name = localStorage.getItem("yandex_user_display") || "";
    who.textContent = name ? `–í—ã –≤–æ—à–ª–∏ –∫–∞–∫ ${name}` : "–í—ã –≤–æ—à–ª–∏";
  }

  // debug
  if (dbg) {
    dbg.textContent = logged ? "yandex mode" : (local ? "local mode" : "not logged");
  }

  // gate buttons
  btnLoginYandex?.classList.toggle("hidden", logged);
  btnDevSkip?.classList.toggle("hidden", logged);
}

/** =========================================================
 *  –ì–õ–û–ë–ê–õ–¨–ù–´–ô STATE + SAVE (–ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞)
 *  ========================================================= */
let state = defaultState();

// –æ—á–µ—Ä–µ–¥—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π (—á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≥–æ–Ω–æ–∫ –ø—Ä–∏ –±—ã—Å—Ç—Ä—ã—Ö –∫–ª–∏–∫–∞—Ö)
let saveQueue = Promise.resolve();

function persist() {
  saveQueue = saveQueue
    .then(async () => {
      if (isYandexLoggedIn()) {
        await saveStateToDisk(state);
      } else {
        saveStateLocal(state);
      }
    })
    .catch((e) => {
      console.error("Save failed:", e);
      // –≤ –ø—Ä–æ—Å—Ç–æ–º –≤–∞—Ä–∏–∞–Ω—Ç–µ –ø—Ä–æ—Å—Ç–æ –º–æ–ª—á–∞ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º, —á—Ç–æ–±—ã UI –Ω–µ –ø–∞–¥–∞–ª
    });
  return saveQueue;
}

/** =========================================================
 *  –î–ù–ï–í–ù–ò–ö (–≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –≤ –æ–¥–Ω–æ–π —Ñ—É–Ω–∫—Ü–∏–∏)
 *  ========================================================= */
function bootDiary() {
  /** ============================
   *  Elements
   *  ============================ */
  const studentSelect = document.getElementById("studentSelect");
  const bookSelect = document.getElementById("bookSelect");
  const dateInput = document.getElementById("dateInput");
  const hwInput = document.getElementById("hwInput");
  const stopInput = document.getElementById("stopInput");
  const lessonForm = document.getElementById("lessonForm");

  const lessonsTbody = document.getElementById("lessonsTbody");
  const emptyState = document.getElementById("emptyState");

  const filterStudent = document.getElementById("filterStudent");
  const filterDate = document.getElementById("filterDate");
  const btnClearDate = document.getElementById("btnClearDate");
  const filterQuery = document.getElementById("filterQuery");
  const btnClearAll = document.getElementById("btnClearAll");

  const btnManageStudents = document.getElementById("btnManageStudents");
  const btnManageBooks = document.getElementById("btnManageBooks");

  const btnExport = document.getElementById("btnExport");
  const fileImport = document.getElementById("fileImport");

  /** ============================
   *  Render helpers
   *  ============================ */
  function renderSelect(selectEl, items, placeholderText="‚Äî –≤—ã–±–µ—Ä–∏ ‚Äî") {
    selectEl.innerHTML = "";
    if (items.length === 0) {
      const opt = document.createElement("option");
      opt.value = "";
      opt.textContent = "–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å —ç–ª–µ–º–µ–Ω—Ç—ã‚Ä¶";
      selectEl.appendChild(opt);
      selectEl.disabled = true;
      return;
    }
    selectEl.disabled = false;

    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = placeholderText;
    placeholder.disabled = true;
    placeholder.selected = true;
    selectEl.appendChild(placeholder);

    for (const it of items) {
      const opt = document.createElement("option");
      opt.value = it.id;
      opt.textContent = it.name;
      selectEl.appendChild(opt);
    }
  }

  function renderFilterStudent() {
    const current = filterStudent.value;
    filterStudent.innerHTML = `<option value="">–í—Å–µ —É—á–µ–Ω–∏–∫–∏</option>`;
    for (const s of state.students) {
      const opt = document.createElement("option");
      opt.value = s.id;
      opt.textContent = s.name;
      filterStudent.appendChild(opt);
    }
    filterStudent.value = current || "";
  }

  function studentName(id){ return (state.students.find(s=>s.id===id)||{}).name || "‚Äî"; }
  function bookById(id){ return state.books.find(b=>b.id===id) || {name:"‚Äî", pdfName:""}; }

  function bookHref(book) {
    if (!book.pdfName) return "";
    return "./" + encodeURIComponent(book.pdfName);
  }

  function lessonMatchesFilters(lesson) {
    const fs = filterStudent.value;
    const fd = filterDate.value;
    const q = (filterQuery.value || "").trim().toLowerCase();

    if (fs && lesson.studentId !== fs) return false;
    if (fd && lesson.date !== fd) return false;
    if (q) {
      const hay = `${lesson.hw || ""} ${lesson.stop || ""}`.toLowerCase();
      if (!hay.includes(q)) return false;
    }
    return true;
  }

  /** ============================
   *  Inline editing for lessons
   *  ============================ */
  let editingLessonId = null;
  let editingDraft = null;

  function startEditLesson(id){
    if (editingLessonId && editingLessonId !== id) cancelEditLesson();
    const lesson = state.lessons.find(l=>l.id===id);
    if (!lesson) return;
    editingLessonId = id;
    editingDraft = JSON.parse(JSON.stringify(lesson));
    renderLessons();
  }
  function cancelEditLesson(){
    editingLessonId = null;
    editingDraft = null;
    renderLessons();
  }
  function saveEditLesson(){
    if (!editingLessonId || !editingDraft) return;
    const idx = state.lessons.findIndex(l=>l.id===editingLessonId);
    if (idx < 0) return;
    state.lessons[idx] = editingDraft;
    persist();
    editingLessonId = null;
    editingDraft = null;
    renderLessons();
  }

  function renderLessons() {
    const filtered = state.lessons
      .slice()
      .sort((a,b) => (b.date||"").localeCompare(a.date||""))
      .filter(lessonMatchesFilters);

    lessonsTbody.innerHTML = "";
    emptyState.classList.toggle("hidden", state.lessons.length !== 0);

    for (const lesson of filtered) {
      const isEditing = lesson.id === editingLessonId;
      const tr = document.createElement("tr");
      tr.className = "border-t border-white/60 hover:bg-white/40";

      if (!isEditing) {
        const book = bookById(lesson.bookId);
        const href = bookHref(book);
        const bookCell = href
          ? `<a class="linkish text-indigo-700 hover:text-indigo-900" href="${href}" target="_blank" rel="noopener">${escapeHtml(book.name)}</a>`
          : `<span>${escapeHtml(book.name)}</span>`;

        tr.innerHTML = `
          <td class="py-3 pr-3 mono whitespace-nowrap">${escapeHtml(lesson.date || "")}</td>
          <td class="py-3 pr-3">${escapeHtml(studentName(lesson.studentId))}</td>
          <td class="py-3 pr-3">${bookCell}</td>
          <td class="py-3 pr-3">${escapeHtml(lesson.hw || "")}</td>
          <td class="py-3 pr-3">${escapeHtml(lesson.stop || "")}</td>
          <td class="py-3 pr-0 text-right whitespace-nowrap">
            <button type="button" data-act="edit" data-id="${lesson.id}"
              class="px-3 py-1 rounded-xl bg-white/80 border border-slate-200 hover:bg-white">‚úèÔ∏è</button>
            <button type="button" data-act="del" data-id="${lesson.id}"
              class="px-3 py-1 rounded-xl bg-white/80 border border-rose-200 text-rose-700 hover:bg-white">üóëÔ∏è</button>
          </td>
        `;
      } else {
        tr.innerHTML = `
          <td class="py-3 pr-3">
            <input data-ed="date" type="date" value="${escapeHtml(editingDraft.date || "")}"
              class="w-full min-w-0 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring mono" />
          </td>

          <td class="py-3 pr-3">
            <select data-ed="student"
              class="w-full min-w-0 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring">
              ${state.students.map(s =>
                `<option value="${s.id}" ${s.id===editingDraft.studentId?'selected':''}>${escapeHtml(s.name)}</option>`
              ).join("")}
            </select>
          </td>

          <td class="py-3 pr-3">
            <select data-ed="book"
              class="w-full min-w-0 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring">
              ${state.books.map(b =>
                `<option value="${b.id}" ${b.id===editingDraft.bookId?'selected':''}>${escapeHtml(b.name)}</option>`
              ).join("")}
            </select>
          </td>

          <td class="py-3 pr-3">
            <input data-ed="hw" type="text" value="${escapeHtml(editingDraft.hw || "")}"
              class="w-full min-w-0 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring" />
          </td>

          <td class="py-3 pr-3">
            <input data-ed="stop" type="text" value="${escapeHtml(editingDraft.stop || "")}"
              class="w-full min-w-0 px-3 py-2 rounded-xl border border-slate-200 bg-white focus-ring" />
          </td>

          <td class="py-3 pr-0 text-right whitespace-nowrap">
            <button type="button" data-act="save" data-id="${lesson.id}"
              class="px-3 py-1 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">‚úÖ</button>
            <button type="button" data-act="cancel" data-id="${lesson.id}"
              class="px-3 py-1 rounded-xl bg-white/80 border border-slate-200 hover:bg-white">‚úñ</button>
          </td>
        `;
      }

      lessonsTbody.appendChild(tr);
    }
  }

  /** ============================
   *  Init
   *  ============================ */
  dateInput.value = todayISO();

  function refreshAll() {
    renderSelect(studentSelect, state.students, "–í—ã–±–µ—Ä–∏ —É—á–µ–Ω–∏–∫–∞");
    renderSelect(bookSelect, state.books, "–í—ã–±–µ—Ä–∏ —É—á–µ–±–Ω–∏–∫");

    if (!studentSelect.disabled) studentSelect.value = state.students[0]?.id || "";
    if (!bookSelect.disabled) bookSelect.value = state.books[0]?.id || "";

    renderFilterStudent();
    renderLessons();
  }
  refreshAll();

  /** ============================
   *  Add lesson
   *  ============================ */
  lessonForm.addEventListener("submit", (e) => {
    e.preventDefault();
    if (state.students.length === 0 || state.books.length === 0) {
      alert("–°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å —É—á–µ–Ω–∏–∫–æ–≤ –∏ —É—á–µ–±–Ω–∏–∫–∏.");
      return;
    }

    const studentId = studentSelect.value || state.students[0]?.id;
    const bookId = bookSelect.value || state.books[0]?.id;
    const date = dateInput.value || todayISO();
    const hw = hwInput.value.trim();
    const stop = stopInput.value.trim();

    if (!studentId || !bookId) { alert("–í—ã–±–µ—Ä–∏ —É—á–µ–Ω–∏–∫–∞ –∏ —É—á–µ–±–Ω–∏–∫."); return; }

    state.lessons.push({ id: uid(), studentId, bookId, date, hw, stop });
    persist();

    hwInput.value = "";
    stopInput.value = "";
    renderLessons();
  });

  /** ============================
   *  Lesson actions
   *  ============================ */
  lessonsTbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-act]");
    if (!btn) return;

    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const lesson = state.lessons.find(x => x.id === id);
    if (!lesson) return;

    if (act === "del") {
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) return;
      state.lessons = state.lessons.filter(x => x.id !== id);
      persist();
      if (editingLessonId === id) cancelEditLesson();
      else renderLessons();
      return;
    }

    if (act === "edit") startEditLesson(id);
    if (act === "cancel") cancelEditLesson();
    if (act === "save") saveEditLesson();
  });

  lessonsTbody.addEventListener("input", (e) => {
    if (!editingLessonId || !editingDraft) return;
    const el = e.target;
    const key = el.getAttribute("data-ed");
    if (!key) return;

    if (key === "date") editingDraft.date = el.value;
    if (key === "student") editingDraft.studentId = el.value;
    if (key === "book") editingDraft.bookId = el.value;
    if (key === "hw") editingDraft.hw = el.value;
    if (key === "stop") editingDraft.stop = el.value;
  });

  /** ============================
   *  Filters
   *  ============================ */
  filterStudent.addEventListener("change", renderLessons);
  filterDate.addEventListener("change", renderLessons);
  filterQuery.addEventListener("input", renderLessons);
  btnClearDate.addEventListener("click", () => { filterDate.value = ""; renderLessons(); });

  btnClearAll.addEventListener("click", () => {
    if (state.lessons.length === 0) return;
    if (!confirm("–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∑–∞–Ω—è—Ç–∏–π?")) return;
    state.lessons = [];
    persist();
    cancelEditLesson();
  });

  /** ============================
   *  Modal management
   *  ============================ */
  const modalBackdrop = document.getElementById("modalBackdrop");
  const modalTitle = document.getElementById("modalTitle");
  const modalSubtitle = document.getElementById("modalSubtitle");
  const modalClose = document.getElementById("modalClose");
  const modalDone = document.getElementById("modalDone");
  const modalList = document.getElementById("modalList");

  const modalNewName = document.getElementById("modalNewName");
  const modalPdfArea = document.getElementById("modalPdfArea");
  const modalNewPdfLabel = document.getElementById("modalNewPdfLabel");
  const modalNewPdfPick = document.getElementById("modalNewPdfPick");
  const modalAddBtn = document.getElementById("modalAddBtn");

  let modalMode = "students"; // "students" | "books"
  let newBookPdfName = "";

  let editingStudentId = null;
  let editingStudentDraft = null;

  let editingBookId = null;
  let editingBookDraft = null;

  function bookHrefByPdfName(pdfName) {
    if (!pdfName) return "";
    return "./" + encodeURIComponent(pdfName);
  }

  function openModal(mode) {
    modalMode = mode;

    editingStudentId = null;
    editingStudentDraft = null;
    editingBookId = null;
    editingBookDraft = null;

    modalNewName.value = "";
    newBookPdfName = "";
    modalNewPdfLabel.value = "PDF –Ω–µ –≤—ã–±—Ä–∞–Ω";
    modalNewPdfPick.value = "";

    const isStudents = mode === "students";
    modalTitle.textContent = isStudents ? "–£—á–µ–Ω–∏–∫–∏" : "–£—á–µ–±–Ω–∏–∫–∏ (PDF)";
    modalSubtitle.textContent = isStudents
      ? "–î–æ–±–∞–≤–ª—è–π/—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π/—É–¥–∞–ª—è–π —É—á–µ–Ω–∏–∫–æ–≤ (–ò–º—è –§–∞–º–∏–ª–∏—è)"
      : "PDF –≤—ã–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ –ø–∞–ø–∫–∏ —Ä—è–¥–æ–º —Å diary.html. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏–º—è —Ñ–∞–π–ª–∞, –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –ø–æ –∫–ª–∏–∫—É –≤ –∏—Å—Ç–æ—Ä–∏–∏.";

    modalPdfArea.classList.toggle("hidden", isStudents);

    renderModalList();
    modalBackdrop.classList.remove("hidden");
    setTimeout(() => modalNewName.focus(), 50);
  }

  function closeModal() {
    modalBackdrop.classList.add("hidden");
    refreshAll();
  }

  function renderModalList() {
    modalList.innerHTML = "";

    if (modalMode === "students") {
      if (state.students.length === 0) {
        modalList.innerHTML = `<div class="text-sm text-slate-600">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –ø–µ—Ä–≤–æ–≥–æ —É—á–µ–Ω–∏–∫–∞ –≤—ã—à–µ.</div>`;
        return;
      }

      for (const s of state.students) {
        const isEditing = s.id === editingStudentId;

        const row = document.createElement("div");
        row.className = "rounded-2xl border border-white/60 bg-white/55 p-4";

        if (!isEditing) {
          row.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="flex-1 min-w-0">
                <div class="text-xs font-medium text-slate-600 mb-1">–£—á–µ–Ω–∏–∫</div>
                <div class="h-11 flex items-center px-3 rounded-xl border border-slate-200 bg-white truncate">
                  ${escapeHtml(s.name)}
                </div>
              </div>

              <div class="flex items-center gap-2 shrink-0">
                <button type="button" data-stu-act="edit" data-id="${s.id}"
                  class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-white border border-slate-200 hover:bg-white shadow-soft"
                  title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>

                <button type="button" data-del-stu="${s.id}"
                  class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-white border border-rose-200 text-rose-700 hover:bg-white shadow-soft"
                  title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
              </div>
            </div>
          `;
        } else {
          row.innerHTML = `
            <div class="flex items-center gap-3">
              <div class="flex-1 min-w-0">
                <div class="text-xs font-medium text-slate-600 mb-1">–£—á–µ–Ω–∏–∫</div>
                <input type="text" data-stu-edit="name"
                  class="h-11 w-full px-3 rounded-xl border border-slate-200 bg-white focus-ring"
                  value="${escapeHtml(editingStudentDraft?.name ?? s.name)}" />
              </div>

              <div class="flex items-center gap-2 shrink-0">
                <button type="button" data-stu-act="save" data-id="${s.id}"
                  class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 shadow-soft"
                  title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">‚úÖ</button>

                <button type="button" data-stu-act="cancel" data-id="${s.id}"
                  class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-white border border-slate-200 hover:bg-white shadow-soft"
                  title="–û—Ç–º–µ–Ω–∞">‚úñ</button>
              </div>
            </div>
          `;
        }

        modalList.appendChild(row);
      }
      return;
    }

    // BOOKS
    if (state.books.length === 0) {
      modalList.innerHTML = `<div class="text-sm text-slate-600">–ü–æ–∫–∞ –ø—É—Å—Ç–æ. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π —É—á–µ–±–Ω–∏–∫ –≤—ã—à–µ.</div>`;
      return;
    }

    for (const b of state.books) {
      const isEditing = b.id === editingBookId;
      const draft = isEditing ? (editingBookDraft || { name: b.name, pdfName: b.pdfName || "" }) : null;

      const nameText = isEditing ? (draft.name || "") : (b.name || "");
      const pdfText = isEditing ? (draft.pdfName || "") : (b.pdfName || "");
      const href = bookHrefByPdfName(pdfText);

      const row = document.createElement("div");
      row.className = "rounded-2xl border border-white/60 bg-white/55 p-4";

      row.innerHTML = `
        <div class="flex items-center gap-3">
          <div class="flex-[0.95] min-w-0">
            <div class="text-xs font-medium text-slate-600 mb-1">–£—á–µ–±–Ω–∏–∫</div>
            ${
              isEditing
                ? `<input type="text" data-book-edit="name"
                     class="h-11 w-full px-3 rounded-xl border border-slate-200 bg-white focus-ring"
                     value="${escapeHtml(nameText)}" />`
                : `<div class="h-11 flex items-center px-3 rounded-xl border border-slate-200 bg-white truncate">
                     ${escapeHtml(nameText)}
                   </div>`
            }
          </div>

          <div class="flex-[1.05] min-w-0">
            <div class="text-xs font-medium text-slate-600 mb-1">PDF</div>
            <div class="h-11 flex items-center px-3 rounded-xl border border-slate-200 bg-slate-50 text-slate-700 truncate">
              ${escapeHtml(pdfText || "PDF –Ω–µ –≤—ã–±—Ä–∞–Ω")}
            </div>
          </div>

          <div class="shrink-0 w-[264px] flex items-center justify-end gap-2">
            <label class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-white border border-slate-200 hover:bg-slate-50 shadow-soft cursor-pointer"
                   title="–í—ã–±—Ä–∞—Ç—å PDF">
              üìé
              <input data-book-pick="${b.id}" type="file" accept="application/pdf" class="hidden">
            </label>

            <a class="h-11 w-[110px] inline-flex items-center justify-center rounded-xl bg-white border border-slate-200 hover:bg-slate-50 shadow-soft whitespace-nowrap
                ${href ? "linkish text-indigo-700" : "pointer-events-none opacity-40"}"
              ${href ? `href="${href}" target="_blank" rel="noopener"` : ""}>
              –û—Ç–∫—Ä—ã—Ç—å
            </a>

            ${
              isEditing
                ? `
                  <button type="button" data-book-act="save" data-id="${b.id}"
                    class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 shadow-soft"
                    title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å">‚úÖ</button>

                  <button type="button" data-book-act="cancel" data-id="${b.id}"
                    class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-white border border-slate-200 hover:bg-white shadow-soft"
                    title="–û—Ç–º–µ–Ω–∞">‚úñ</button>
                `
                : `
                  <button type="button" data-book-act="edit" data-id="${b.id}"
                    class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-white border border-slate-200 hover:bg-white shadow-soft"
                    title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úèÔ∏è</button>

                  <button type="button" data-del-book="${b.id}"
                    class="h-11 w-11 inline-flex items-center justify-center rounded-xl bg-white border border-rose-200 text-rose-700 hover:bg-white shadow-soft"
                    title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                `
            }
          </div>
        </div>
      `;

      modalList.appendChild(row);
    }
  }

  modalNewPdfPick.addEventListener("change", () => {
    const f = modalNewPdfPick.files?.[0];
    if (!f) return;
    newBookPdfName = f.name;
    modalNewPdfLabel.value = f.name;
  });

  modalAddBtn.addEventListener("click", () => {
    const name = modalNewName.value.trim();
    if (!name) return;

    if (modalMode === "students") {
      if (state.students.some(x => (x.name || "").trim().toLowerCase() === name.toLowerCase())) {
        alert("–¢–∞–∫–æ–π —É—á–µ–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å.");
        return;
      }
      state.students.push({ id: uid(), name });
      persist();
      modalNewName.value = "";
      renderModalList();
      refreshAll();
      return;
    }

    if (state.books.some(x => (x.name || "").trim().toLowerCase() === name.toLowerCase())) {
      alert("–¢–∞–∫–æ–π —É—á–µ–±–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å.");
      return;
    }
    state.books.push({ id: uid(), name, pdfName: newBookPdfName || "" });
    persist();

    modalNewName.value = "";
    newBookPdfName = "";
    modalNewPdfLabel.value = "PDF –Ω–µ –≤—ã–±—Ä–∞–Ω";
    modalNewPdfPick.value = "";

    renderModalList();
    refreshAll();
  });

  modalList.addEventListener("input", (e) => {
    if (modalMode === "students" && editingStudentId) {
      if (e.target.getAttribute("data-stu-edit") === "name") {
        editingStudentDraft.name = e.target.value;
      }
      return;
    }
    if (modalMode === "books" && editingBookId) {
      if (e.target.getAttribute("data-book-edit") === "name") {
        editingBookDraft.name = e.target.value;
      }
      return;
    }
  });

  modalList.addEventListener("change", (e) => {
    const pickId = e.target.getAttribute("data-book-pick");
    if (!pickId) return;

    const f = e.target.files?.[0];
    if (!f) return;

    const b = state.books.find(x => x.id === pickId);
    if (!b) return;

    editingBookId = pickId;
    editingBookDraft = { name: b.name, pdfName: f.name };
    renderModalList();
  });

  modalList.addEventListener("click", (e) => {
    const delStuBtn = e.target.closest("button[data-del-stu]");
    if (delStuBtn) {
      const id = delStuBtn.getAttribute("data-del-stu");
      const used = state.lessons.some(l => l.studentId === id);
      if (used) { alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å: —É—á–µ–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏."); return; }
      if (!confirm("–£–¥–∞–ª–∏—Ç—å —É—á–µ–Ω–∏–∫–∞?")) return;

      state.students = state.students.filter(x => x.id !== id);
      persist();
      refreshAll();
      renderModalList();
      return;
    }

    const stuActBtn = e.target.closest("button[data-stu-act]");
    if (stuActBtn) {
      const act = stuActBtn.getAttribute("data-stu-act");
      const id = stuActBtn.getAttribute("data-id");
      const s = state.students.find(x => x.id === id);
      if (!s) return;

      if (act === "edit") {
        editingStudentId = id;
        editingStudentDraft = { name: s.name };
        renderModalList();
        return;
      }
      if (act === "cancel") {
        editingStudentId = null;
        editingStudentDraft = null;
        renderModalList();
        return;
      }
      if (act === "save") {
        const newName = (editingStudentDraft?.name || "").trim();
        if (!newName) { alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."); return; }

        const dup = state.students.some(x =>
          x.id !== id && (x.name || "").trim().toLowerCase() === newName.toLowerCase()
        );
        if (dup) { alert("–¢–∞–∫–æ–π —É—á–µ–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å. –î–æ–±–∞–≤—å –Ω–æ–º–µ—Ä (–°–æ–Ω—è 2)."); return; }

        s.name = newName;
        persist();
        refreshAll();

        editingStudentId = null;
        editingStudentDraft = null;
        renderModalList();
        return;
      }
    }

    const delBookBtn = e.target.closest("button[data-del-book]");
    if (delBookBtn) {
      const id = delBookBtn.getAttribute("data-del-book");
      const used = state.lessons.some(l => l.bookId === id);
      if (used) { alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å: —É—á–µ–±–Ω–∏–∫ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∏—Å—Ç–æ—Ä–∏–∏."); return; }
      if (!confirm("–£–¥–∞–ª–∏—Ç—å —É—á–µ–±–Ω–∏–∫?")) return;

      state.books = state.books.filter(x => x.id !== id);
      persist();
      refreshAll();
      renderModalList();
      return;
    }

    const bookActBtn = e.target.closest("button[data-book-act]");
    if (bookActBtn) {
      const act = bookActBtn.getAttribute("data-book-act");
      const id = bookActBtn.getAttribute("data-id");
      const b = state.books.find(x => x.id === id);
      if (!b) return;

      if (act === "edit") {
        editingBookId = id;
        editingBookDraft = { name: b.name, pdfName: b.pdfName || "" };
        renderModalList();
        return;
      }
      if (act === "cancel") {
        editingBookId = null;
        editingBookDraft = null;
        renderModalList();
        return;
      }
      if (act === "save") {
        const newName = (editingBookDraft?.name || "").trim();
        const newPdf = (editingBookDraft?.pdfName || "").trim();
        if (!newName) { alert("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."); return; }

        const dup = state.books.some(x =>
          x.id !== id && (x.name || "").trim().toLowerCase() === newName.toLowerCase()
        );
        if (dup) { alert("–¢–∞–∫–æ–π —É—á–µ–±–Ω–∏–∫ —É–∂–µ –µ—Å—Ç—å."); return; }

        b.name = newName;
        b.pdfName = newPdf;

        persist();
        refreshAll();

        editingBookId = null;
        editingBookDraft = null;
        renderModalList();
        return;
      }
    }
  });

  modalClose.addEventListener("click", closeModal);
  modalDone.addEventListener("click", closeModal);
  modalBackdrop.addEventListener("click", (e) => { if (e.target === modalBackdrop) closeModal(); });

  btnManageStudents.addEventListener("click", () => openModal("students"));
  btnManageBooks.addEventListener("click", () => openModal("books"));

  /** ============================
   *  Export / Import
   *  ============================ */
  btnExport.addEventListener("click", () => {
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `diary-backup-${todayISO()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  fileImport.addEventListener("change", async () => {
    const file = fileImport.files?.[0];
    if (!file) return;

    try {
      const text = await file.text();
      const imported = JSON.parse(text);

      if (!imported || typeof imported !== "object") throw new Error("bad");
      if (!Array.isArray(imported.students) || !Array.isArray(imported.books) || !Array.isArray(imported.lessons)) {
        throw new Error("bad");
      }

      state = imported;
      persist();
      refreshAll();
      alert("–ò–º–ø–æ—Ä—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ");
    } catch {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å: —Ñ–∞–π–ª –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π.");
    } finally {
      fileImport.value = "";
    }
  });
}

/** =========================================================
 *  BOOTSTRAP (–æ–¥–∏–Ω —Ä–∞–∑)
 *  ========================================================= */
document.addEventListener("DOMContentLoaded", async () => {
  // 1) –µ—Å–ª–∏ –≤–µ—Ä–Ω—É–ª–∏—Å—å –æ—Ç OAuth
  await handleOAuthReturn();

  // 2) –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ (–∏ –≤ gate, –∏ –≤ —à–∞–ø–∫–µ)
  document.getElementById("btnLoginYandex")?.addEventListener("click", startYandexLogin);
  document.getElementById("btnLoginTop")?.addEventListener("click", startYandexLogin);

  document.getElementById("btnDevSkip")?.addEventListener("click", () => {
    localStorage.setItem("auth_mode", "local");
    location.reload(); // –ø—Ä–æ—â–µ –∏ –Ω–∞–¥–µ–∂–Ω–µ–µ
  });

  document.getElementById("btnLogout")?.addEventListener("click", () => {
    if (!confirm("–í—ã–π—Ç–∏?")) return;
    localStorage.removeItem("yandex_oauth_token");
    localStorage.removeItem("yandex_user_display");
    localStorage.removeItem("yandex_oauth_state");
    // –ø–æ—Å–ª–µ –≤—ã—Ö–æ–¥–∞ ‚Äî –ø—É—Å—Ç—å –±—É–¥–µ—Ç local —Ä–µ–∂–∏–º (—á—Ç–æ–±—ã –Ω–µ ¬´–∑–∞–ø–∏—Ä–∞–ª–æ—Å—å¬ª)
    localStorage.setItem("auth_mode", "local");
    location.reload();
  });

  document.getElementById("btnSwitch")?.addEventListener("click", () => {
    // –ø—Ä–æ—Å—Ç–æ –∑–∞–Ω–æ–≤–æ –ª–æ–≥–∏–Ω–∏–º—Å—è (—Å prompt=login)
    localStorage.removeItem("yandex_oauth_token");
    localStorage.removeItem("yandex_user_display");
    localStorage.removeItem("yandex_oauth_state");
    startYandexLogin();
  });

  // 3) –ø–æ–∫–∞–∑–∞—Ç—å gate/app
  showAppOrLogin();

  // –µ—Å–ª–∏ –µ—â—ë –Ω–µ –≤—ã–±—Ä–∞–ª–∏ —Ä–µ–∂–∏–º –∏ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã ‚Äî –ø—Ä–æ—Å—Ç–æ –∂–¥—ë–º (gate –æ—Ç–∫—Ä—ã—Ç)
  if (!canEnterApp()) return;

  // 4) –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ (—Å—Ç—Ä–æ–≥–æ: –≤ —Ä–µ–∂–∏–º–µ –≤—Ö–æ–¥–∞ ‚Äî —Ç–æ–ª—å–∫–æ –î–∏—Å–∫)
  try {
    if (isYandexLoggedIn()) {
      setSyncOverlay(true, "–¢—è–Ω—É –¥–∞–Ω–Ω—ã–µ —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞‚Ä¶");
      state = await loadStateFromDisk();
      setSyncOverlay(false);
    } else {
      state = loadStateLocal();
    }
  } catch (e) {
    console.error(e);
    setSyncOverlay(false);

    if (isYandexLoggedIn()) {
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫–∞. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –ø–æ–ø—Ä–æ–±—É–π —Å–Ω–æ–≤–∞.");
      // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ gate
      localStorage.removeItem("yandex_oauth_token");
      localStorage.removeItem("yandex_user_display");
      localStorage.removeItem("yandex_oauth_state");
      localStorage.removeItem("auth_mode");
      showAppOrLogin();
      return;
    }

    state = loadStateLocal();
  }

  // 5) –∑–∞–ø—É—Å–∫–∞–µ–º –¥–Ω–µ–≤–Ω–∏–∫
  bootDiary();
});
</script>

</body>
</html>
